"use strict"
console.log('bly.js v0.1测试版本');var lableExp=/(\<\/?)([a-z]+?)(\b.*?)(\>)/;var leftTextExp=/([.\w\W-\>\:\<]+?)(\<\/?[a-z]+?\b.*?\>)/;var attrExp=/(.+?)\=[\'\"](.+?)[\'\"]/g;var embedVarExp=RegExp('{{(.+?)}}','ig');var notesExp=RegExp('<!--(.*)-->','ig');var singleTable=['br','hr','img','input','param','meta','link'];var GTS=null
function update(arr,val){if(!(arr)||arr.length<=0)return;if(typeof(val)=='object'){val=val.value;}
arr.forEach(function(node){node.nodeType==3?node.nodeValue=val:node.value=val;})}
function bind(node,obj){if(typeof(obj)=='object'){obj.bind.push(node);}else{obj={bind:[],value:obj};obj.bind.push(node);}
return obj;}
class Bly{constructor(options){this.root=document.getElementById(options.el);var _data=options.data;this.methods=options.methods;this.compute=options.compute;this.data=this.PROXY(_data);var _dom=this._compile(this.root.innerHTML,this);var dom=this.render(_dom);this.root.innerHTML='';this.root.appendChild(dom);}
_compile(rootString){var container={childs:[]};rootString=rootString.replace(notesExp,'');this.seek(rootString,container);return container;}
seek(str,container){var match=null;if(leftTextExp.test(str)){str=str.replace(leftTextExp,function(){match=arguments;if(match[1].replace(/\s/g,'').length>0){container.childs.push(match[1])}
return match[2];})}
if(lableExp.test(str)){str=str.replace(lableExp,function(){match=arguments;return'';})
if(!match)return;if(match[1]=='<'){var obj=h(match[2],[],[]);if(attrExp.test(match[3])){match[3].replace(attrExp,function(){var a1=arguments[1].trim();var a2=arguments[2].trim();obj.props[a1]=a2;})}
container.childs.push(obj);for(var key in singleTable){if(match[2]==singleTable[key]){GTS=1;break;}else{GTS=0;}}
if(GTS==0){str=this.seek(str,obj);}
str=this.seek(str,container);GTS=null;}}
return str;}
render(dom){if(!dom)return;var _this=this;var node=document.createDocumentFragment();Object.keys(dom).forEach(function(ite){switch(ite){case'name':node=document.createElement(dom[ite]);break;case'props':for(var key in dom[ite]){node.setAttribute(key,dom[ite][key]);}
var attributeValue=node.getAttribute('tie');if(node.hasAttribute(("tie"))&&node.tagName.toLocaleUpperCase()=="INPUT"||node.tagName.toLocaleUpperCase()=="TEXTAREA"){node.addEventListener("input",function(){var evalExp='_this.data.m=node.value';evalExp=evalExp.replace(/m/ig,attributeValue);eval(evalExp);})
var evalExp='_this.data.m=bind(node,_this.data.m)';evalExp=evalExp.replace(/m/ig,attributeValue);eval(evalExp);}
break;case'childs':dom[ite].forEach(function(item,index){if(isString(item)){var matches=item.match(embedVarExp);var splitTextNodes=item.split(/\{\{.+?\}\}/);if(matches){var newMatches=matches.map(function(item){return item.replace(/\{\{(.+?)\}\}/,'$1');})
if(splitTextNodes[0]){node.appendChild(document.createTextNode(splitTextNodes[0]));}
for(var ii=0;ii<newMatches.length;ii++){var m=newMatches[ii];var el=document.createTextNode('');node.appendChild(el);if(splitTextNodes[ii+1]){node.appendChild(document.createTextNode(splitTextNodes[ii+1]));}
var evalExp='_this.data.m=bind(el,_this.data.m)';evalExp=evalExp.replace(/m/ig,m);eval(evalExp);}}else{node.appendChild(document.createTextNode(item));}}else{node.appendChild(_this.render(item));}})
break;}})
return node;}
PROXY(data){var p=new Proxy(data,handler);for(var i in data){var obj=data[i];if(isObject(obj)||isArray(obj)){p[i]=this.PROXY(obj);}}
return p;}}
var handler={get:function(target,prop){return Reflect.get(target,prop);},set:function(target,prop,newVal,receiver){if(typeof(newVal)=='object'||!(target[prop].hasOwnProperty('value'))){Reflect.set(target,prop,newVal);}else{Reflect.set(target[prop],'value',newVal);}
update(target[prop].bind,newVal);return true;}}